<div>
  <div id="container">
    <form id="userFilterForm">
      <label for="user">Username:</label>
      <input type="text" name="user" />
      <button type="submit">Search</button>
    </form>
    <hr />

    <div id="usersList">
      <button>lorum</button><button>lorum</button><button>lorum</button><button
        >lorum</button
      ><button>lorum</button><button>lorum</button><button>lorum</button><button
        >lorum</button
      ><button>lorum</button><button>lorum</button>
    </div>
  </div>
  <div id="userMessages"></div>
</div>

<style is:global>
  #usersList {
    display: flex;
  }

  #usersList button {
    border: none;
    background-color: red;
    padding-right: 10px;
  }

  #container {
    padding: 10px;
    border: 2px solid gray;
  }
</style>

<script>
  import {
    collection,
    getDocs,
    limit,
    orderBy,
    query,
    QueryDocumentSnapshot,
    Timestamp,
    where,
  } from "firebase/firestore";
  import { db } from "../scripts/firestore";
  import { makeP } from "../scripts/helper";
  
  type UserDoc = {
    email: string;
    displayName: string,
    messagesSent: number,
  };

  type MessageDoc = {
    text: string;
    createdAt: Timestamp;
    userName: string;
  };

  async function fetchTopUsers() {
    const q = query(
      collection(db, "users"),
      orderBy("messagesSent", "desc"),
      limit(10),
    );

    return getDocs(q);
  }

  async function searchUsers(keyword: string) {
    const q = query(
      collection(db, "users"),
      where("displayName", ">=", keyword),
      where("displayName", "<=", keyword + "\uf8ff"),
      limit(10),
    );

    return getDocs(q);
  }

  async function fetchUserMessages(user: string) {
    const q = query(
      collection(db, "messages"),
      // TODO: replace the `userName` field in messages with displayName to be more clear.
      where("userName", "==", user),
      orderBy("createdAt", "desc"),
      limit(10),
    );

    return getDocs(q);
  }

  const usersList = document.getElementById("usersList")!;
  const userMessages = document.getElementById("userMessages")!;

  function renderUserButtons(docs: QueryDocumentSnapshot[]) {
    usersList.innerHTML = "";

    docs.forEach((doc) => {
      const data = doc.data() as UserDoc;
      console.log(data);
      
      if (!data.email) return;

      const btn = document.createElement("button");
      btn.textContent = data.displayName;
      btn.dataset.user = data.displayName;

      usersList.appendChild(btn);
    });
  }

  function renderMessages(docs: QueryDocumentSnapshot[]) {
    userMessages.innerHTML = "";       

    docs.forEach((doc) => {
      const data = doc.data() as MessageDoc;
      const date = data.createdAt.toDate();

      const wrapper = document.createElement("div");
      wrapper.replaceChildren(
        makeP(data.text),
        makeP(date.toLocaleTimeString())
      )
      // wrapper.innerHTML = `
      //       <p>${data.text}</p>
      //       <p>${date.toLocaleTimeString()}</p>
      //   `;

      userMessages.appendChild(wrapper);
    });
  }

  usersList.addEventListener("click", async (e) => {
    const target = e.target as HTMLElement;
    if (target.tagName !== "BUTTON") return;

    const user = target.dataset.user!;
    const snapshot = await fetchUserMessages(user);
    renderMessages(snapshot.docs);
  });

  const userFilterForm = document.getElementById(
    "userFilterForm",
  ) as HTMLFormElement;

  userFilterForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(userFilterForm);
    const keyword = String(formData.get("user") || "");

    const snapshot = await searchUsers(keyword);
    
    renderUserButtons(snapshot.docs);
  });

  (async function init() {
    const snapshot = await fetchTopUsers();
    renderUserButtons(snapshot.docs);
  })();
</script>
